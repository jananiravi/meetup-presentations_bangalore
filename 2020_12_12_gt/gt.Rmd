---
title: "gt tables"
subtitle: "Using the gt package to create great tables"  
author: 
  - "Pavitra Chakravarty"
date: '2020-12-10'
output:
  xaringan::moon_reader:
    lib_dir: libs
    chakra: assets/remark-0.14.0.min.js
    css: ["xaringan-themer.css","custom.css"]
    seal: false
    nature:
      highlightStyle: atom-one-light
      highlightLines: true
      ratio: "16:9"
      countIncrementalSlides: true
      slideNumberFormat: "%current%"

---

class: title-slide middle

# `r rmarkdown::metadata$title`

## `r rmarkdown::metadata$subtitle`

.author[
`r rmarkdown::metadata$author`
]

.twitter[
@genomixgmailcom
]



```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

```{r global.options, include = FALSE}
knitr::opts_chunk$set(
    fig.width   = 15,       # the width for plots created by code chunk
    fig.height  = 8,        # the height for plots created by code chunk
    fig.align   = 'center', # how to align graphics in the final doc. 'left', 'right', 'center'
    fig.path    = 'figs/',  # file path to the directory where knitr shall store the graphics files
    results     = 'asis',   # knitr will pass through results without reformatting them
    echo        = TRUE,     # in FALSE knitr will not display code in the code chunk above it's results
    message     = TRUE,     # if FALSE knitr will not display any messages generated by code
    strip.white = TRUE,     # if FALSE knitr will not remove white spaces at the beg or end of code chunk
    warning     = FALSE)    # if FALSE knitr will not display any warning messages in the final document
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
library(gt)
library(tidyverse)

style_duo_accent(
  base_font_size = "22px",
  primary_color = "#1381B0",
  secondary_color = "#FF961C",
  inverse_header_color = "#FFFFFF",
  title_slide_text_color = "#FFFFFF",
  code_inline_font_size = "1em",
  extra_fonts = list(
    google_font("Staatliches"),
    google_font("Megrim"),
    google_font("Pompiere")
  )
)

```

```{r setup extra, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      comment = "")
xaringanExtra::use_tile_view()
xaringanExtra::use_panelset()
xaringanExtra::use_webcam()
xaringanExtra::use_editable()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)
```
---

class: middle

# Create/Preview/Save gt tables

---

## gt() function call 

gt(
  data,
  rowname_col = "rowname",
  groupname_col = dplyr::group_vars(data),
  rownames_to_stub = FALSE,
  auto_align = TRUE,
  id = NULL,
  row_group.sep = getOption("gt.row_group.sep", " - ")
)

We need to first get a **gt** table object. We are going to test most of our examples with the exibble dataset

```{r}
exibble %>% dplyr::sample_n(size = 4) %>% gt()
```

---

class: middle

### What do rowname_col and groupname_col do?


```{r}
exibble %>% dplyr::sample_n(size = 4) %>% gt(rowname_col = "row", groupname_col = "group")
```

---

```{r}
mtcars %>% dplyr::sample_n(size = 4) %>% gt(rownames_to_stub = TRUE)
```

---

```{r}
exibble %>% dplyr::sample_n(size = 4) %>%
  dplyr::group_by(group) %>%
  gt(rowname_col = "row")
```

---

class: middle

## What does a gt_preview() call look like? 

``` r
gt_preview(
  data,
  top_n = 5,
  bottom_n = 1,
  incl_rownums = TRUE
)
```

```{r}
exibble %>%
  dplyr::select(num, char, fctr) %>%
  gt_preview(incl_rownums = FALSE)
```

---

class: middle

## What does a gt_save() call look like? 
### Can save tbl in HTML, PDF, PNG, LaTeX, or RTF formats

``` r
gtsave(
  data,
  filename,
  path = NULL,
  inline_css = TRUE
  ...
)
```

```{r}
gt_tbl <-
  exibble %>%
  gt(
    rowname_col = "row",
    groupname_col = "group"
  ) %>% gtsave("tab_1_inlined.html", inline_css = TRUE)
```

---

class: middle

# Summary

.pull-left[
    
### gt() 
### gt_preview()
### gtsave()
      
  ]

.pull-right[
  
### get tbl in right form - create gt
### quick preview of tbl
### save tbl by providing required format
  
]


---

class: middle

# Create/Modify parts

---

class: middle

### `tab_stubhead()`: add title to the stub space

``` r
tab_stubhead(
  data,
  label
)
```
```{r}
exibble %>% dplyr::sample_n(size = 4) %>% 
  gt(rowname_col = "row", groupname_col = "group") %>% 
  tab_stubhead(label="Row name")
```

---

class: middle

### `tab_spanner()`: Add a spanner column label

``` r
tab_spanner(
  data,
  label,
  columns,
  gather = TRUE
)
```

---

```{r}
gtcars %>% dplyr::sample_n(size = 4) %>%
  dplyr::select(model, mfr, hp_rpm, trq_rpm, mpg_c, mpg_h) %>%
  gt(rowname_col = "model") %>% tab_stubhead(label="Model") %>%
  tab_spanner(
    label = "performance",
    columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h)
  )
```

---

### `tab_header()`: Add a header to the table

``` r
tab_header(
  data,
  title,
  subtitle = NULL
)
```

### `tab_source_note()`: Source note citation for entire table

``` r
tab_source_note(
  data,
  source_note
)
```

---

```{r}
gtcars %>% dplyr::sample_n(size = 4) %>%
  dplyr::select(model, mfr, hp_rpm, trq_rpm, mpg_c, mpg_h) %>%
  gt(rowname_col = "model") %>% tab_stubhead(label="Model") %>%
  tab_spanner(
    label = "performance",
    columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h)
  ) %>%
  tab_header(title ="Cars", subtitle ="Different Models") %>%
  tab_source_note(
    source_note = "Data with information on different models")
```

---

### `tab_footnote()`: Footnotes are location-specific
``` r
tab_footnote(
  data,
  footnote,
  locations
)
```

### locations are : 
- `cells_title()` - target the table title or subtitle
- `cells_stubhead()` - target the table stubhead cell
- `cells_column_spanners()` - target the column spanners
- `cells_column_labels()` - target the column labels
- `cells_row_groups()` - target row groups
- `cells_stub()` - target cells in the table stub
- `cells_body()` - target data cells in the table body
- `cells_summary()` - target group summary cells
- `cells_grand_summary()` - target cells in a grand summary

---
```{r}
gtcars %>% dplyr::sample_n(size = 4) %>%
  dplyr::select(model, mfr, hp_rpm, trq_rpm, mpg_c, mpg_h) %>%
  gt(rowname_col = "model") %>% tab_stubhead(label="Model") %>%
  tab_spanner(
    label = "performance",
    columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h)
  ) %>%
  tab_header(title ="Cars", subtitle ="Different Models") %>%
  tab_source_note(
  source_note = md("*Data with information on different models*"))  %>%
  tab_footnote(
    footnote = "This is a mpg-related column.",
    locations = cells_column_labels(columns = vars(mpg_c,mpg_h))
  )
```

---

```{r}
gtcars %>% dplyr::sample_n(size = 4) %>%
  dplyr::select(model, mfr, hp_rpm, trq_rpm, mpg_c, mpg_h) %>%
  gt(rowname_col = "model") %>% tab_stubhead(label="Model") %>%
  tab_spanner(
    label = "performance",
    columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h)
  ) %>%
  tab_header(title ="Cars", subtitle ="Different Models") %>%
  tab_source_note(
  source_note = md("*Data with information on different models*"))  %>%
  tab_footnote(
    footnote = "This is a mpg-related column.",
    locations = cells_column_labels(columns = vars(mpg_c,mpg_h))) %>%
  tab_style(
    style = list(
      cell_fill(color = "cyan"),
      cell_text(weight = "bold")
      ),
    locations = cells_body(
      columns = vars(mpg_h),
      rows = mpg_h >= 29
    )
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "#F9E3D6"),
      cell_text(style = "italic")
      ),
    locations = cells_body(
      columns = vars(hp_rpm),
      rows = hp_rpm <= 7000
    )
  )
```

------

### `tab_options()`: Modify the table output options


```{r}
gtcars %>% dplyr::sample_n(size = 4) %>%
  dplyr::select(model, mfr, hp_rpm, trq_rpm, mpg_c, mpg_h) %>%
  gt(rowname_col = "model") %>% tab_stubhead(label="Model") %>%
  tab_spanner(
    label = "performance",
    columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h)
  ) %>%
  tab_header(title ="Cars", subtitle ="Different Models") %>%
  tab_source_note(
  source_note = md("*Data with information on different models*"))  %>%
  tab_style(
    style = list(
      cell_fill(color = "cyan"),
      cell_text(weight = "bold")
      ),
    locations = cells_body(
      columns = vars(mpg_h),
      rows = mpg_h >= 20
    )
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "#F9E3D6"),
      cell_text(style = "italic")
      ),
    locations = cells_body(
      columns = vars(hp_rpm),
      rows = hp_rpm <= 7000
    )
  ) %>%
  tab_options(
    footnotes.marks = letters
  ) %>%
  tab_footnote(
    footnote = "This is a mpg-related column.",
    locations = cells_column_labels(columns = vars(mpg_c,mpg_h))) %>%
  tab_options(
    table.background.color = "lightgrey"
  )  %>% 
  tab_options(data_row.padding = px(15))
```

---

class: middle

# Summary

.pull-left[
    
### tab_header() 
### tab_source_note()
### tab_spanner()
### tab_footnote()
### tab_style()
### tab_options()
      
  ]

.pull-right[
  
### tbl titles/subtitles
### footer notes for the entire tbl
### col labels over selected cols
### footnotes using `cells_*()`
### targeting and style combined
### options that affect entire tbl
  
]

---

class: middle

# Foramtting of data in gt

---

### Functions in this module

- `fmt_number()`
- `fmt_scientific()`
- `fmt_percent()`
- `fmt_currency()`
- `fmt_date()`
- `fmt_time()`
- `fmt_datetime()`
- `fmt_markdown()`
- `fmt_missing()`
- `data_color()`

Information functions:

- `info_locales()`
- `info_currencies()`
- `info_date_style()`
- `info_time_style()`
- `info_paletteer()`

---

```{r}
gtcars %>% dplyr::sample_n(size = 4) %>%
  dplyr::select(model, mfr, hp_rpm, trq_rpm, mpg_c, mpg_h) %>%
  gt(rowname_col = "model") %>% tab_stubhead(label="Model") %>%
  tab_spanner(
    label = "performance",
    columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h)
  ) %>%
  tab_header(title ="Cars", subtitle ="Different Models") %>%
  tab_source_note(
  source_note = md("*Data with information on different models*"))  %>%
  tab_style(
    style = list(
      cell_fill(color = "cyan"),
      cell_text(weight = "bold")
      ),
    locations = cells_body(
      columns = vars(mpg_h),
      rows = mpg_h >= 20
    )
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "#F9E3D6"),
      cell_text(style = "italic")
      ),
    locations = cells_body(
      columns = vars(hp_rpm),
      rows = hp_rpm <= 7000
    )
  ) %>%
  tab_options(
    footnotes.marks = letters
  ) %>%
  tab_footnote(
    footnote = "This is a mpg-related column.",
    locations = cells_column_labels(columns = vars(mpg_c,mpg_h))) %>%
  tab_options(
    table.background.color = "lightgrey"
  )  %>% 
  tab_options(data_row.padding = px(15)) %>%
  fmt_number(columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h), row = mpg_h>=25)
```

---

```{r}
gtcars %>% 
  dplyr::select(model, mfr, hp_rpm, trq_rpm, mpg_c, mpg_h) %>%
  gt(rowname_col = "model") %>% tab_stubhead(label="Model") %>%
  tab_spanner(
    label = "performance",
    columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h)
  ) %>%
  tab_header(title ="Cars", subtitle ="Different Models") %>%
  tab_source_note(
  source_note = md("*Data with information on different models*"))  %>%
  tab_style(
    style = list(
      cell_fill(color = "cyan"),
      cell_text(weight = "bold")
      ),
    locations = cells_body(
      columns = vars(mpg_h),
      rows = mpg_h >= 20
    )
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "#F9E3D6"),
      cell_text(style = "italic")
      ),
    locations = cells_body(
      columns = vars(hp_rpm),
      rows = hp_rpm <= 7000
    )
  ) %>%
  tab_options(
    footnotes.marks = letters
  ) %>%
  tab_footnote(
    footnote = "This is a mpg-related column.",
    locations = cells_column_labels(columns = vars(mpg_c,mpg_h))) %>%
  tab_options(
    table.background.color = "lightgrey"
  )  %>% 
  tab_options(data_row.padding = px(15)) %>%
  fmt_number(columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h), row = mpg_h>=25) %>%
  data_color(
    columns = vars(hp_rpm),
     colors = scales::col_numeric(
      palette = paletteer::paletteer_d(
        palette = "ggsci::red_material") %>% as.character(),
      domain = NULL ))
```


---

class: middle

# Summary

.pull-left[
    
### fmt_number(), fmt_percent(), fmt_currency()
### fmt_missing()
### data_color()
### info_currencies(), info_google_fonts(), info_locales()
  ]

.pull-right[
  
### Formatting numbers/pct/scientific nos
### substitute missing values
### **scales**/**paletteer** color gradient
### numerous `info_*()` functions
  
]

---

class: middle

# Modification of columns in gt

---

### Functions in this module

- `cols_align()`
- `cols_label()`
- `cols_width()`
- `cols_move()`
- `cols_hide()`
- `cols_merge_range()`
- `cols_merge_uncert()`
- `cols_merge()`

---


```{r}
gtcars %>% 
  dplyr::select(model, mfr, hp_rpm, trq_rpm, mpg_c, mpg_h) %>%
  gt(rowname_col = "model") %>% tab_stubhead(label="Model") %>%
  tab_spanner(
    label = "performance",
    columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h)
  ) %>%
  tab_header(title ="Cars", subtitle ="Different Models") %>%
  tab_source_note(
  source_note = md("*Data with information on different models*"))  %>%
  tab_style(
    style = list(
      cell_fill(color = "cyan"),
      cell_text(weight = "bold")
      ),
    locations = cells_body(
      columns = vars(mpg_h),
      rows = mpg_h >= 20
    )
  )  %>%
  tab_footnote(
    footnote = "This is a mpg-related column.",
    locations = cells_column_labels(columns = vars(mpg_c,mpg_h))) %>%
  tab_options(
    table.background.color = "lightgrey"
  )  %>% 
  tab_options(data_row.padding = px(15)) %>%
  fmt_number(columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h), row = mpg_h>=25) %>%
  data_color(
    columns = vars(hp_rpm),
     colors = scales::col_numeric(
      palette = paletteer::paletteer_d(
        palette = "ggsci::red_material") %>% as.character(),
      domain = NULL )) %>%
    cols_align(
    align = "left",
    columns = vars(mpg_c,mpg_h))

```

---

### `cols_label()`: Relabel one or more columns

``` r
cols_label(
  data,
  ...,
  .list = list2(...)
)
```

```{r}
gtcars %>% 
  dplyr::select(model, mfr, hp_rpm, trq_rpm, mpg_c, mpg_h) %>%
  gt(rowname_col = "model") %>% tab_stubhead(label="Model") %>%
  tab_spanner(
    label = "performance",
    columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h)
  ) %>%
  tab_header(title ="Cars", subtitle ="Different Models") %>%
  tab_source_note(
  source_note = md("*Data with information on different models*"))  %>%
  tab_style(
    style = list(
      cell_fill(color = "cyan"),
      cell_text(weight = "bold")
      ),
    locations = cells_body(
      columns = vars(mpg_h),
      rows = mpg_h >= 20
    )
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "#F9E3D6"),
      cell_text(style = "italic")
      ),
    locations = cells_body(
      columns = vars(hp_rpm),
      rows = hp_rpm <= 7000
    )
  ) %>%
  tab_options(
    footnotes.marks = letters
  ) %>%
  tab_footnote(
    footnote = "This is a mpg-related column.",
    locations = cells_column_labels(columns = vars(mpg_c,mpg_h))) %>%
  tab_options(
    table.background.color = "lightgrey"
  )  %>% 
  tab_options(data_row.padding = px(15)) %>%
  fmt_number(columns = vars(hp_rpm, trq_rpm, mpg_c, mpg_h), row = mpg_h>=25) %>%
  data_color(
    columns = vars(hp_rpm),
     colors = scales::col_numeric(
      palette = paletteer::paletteer_d(
        palette = "ggsci::red_material") %>% as.character(),
      domain = NULL )) %>%
    cols_align(
    align = "left",
    columns = vars(mpg_c,mpg_h)) %>%
  
   cols_align(
    align = "right",
    columns = vars(mfr)) %>%
  
  cols_label(
    mfr    = "Brand",
    hp_rpm = "RPM",
    trq_rpm = "Torque rpm"
  )  %>%
  cols_width(
    vars(mfr) ~ px(75),
    ends_with("rpm") ~ px(75),
    starts_with("mpg") ~ px(75),
    TRUE ~ px(60)) 
```

---

class: middle

# Summary

.pull-left[
    
### cols_align()
### cols_label()
### cols_merge_range()
### cols_merge_uncert()
### cols_merge()
### cols_width(): px(),pct()
  ]

.pull-right[
  
### align values in column
### set col labels not vars
### ranged values
### ranged values
### ranged values
### Set width with helper fns:px() and pct()
  
]

---

class: middle

# Adding summary rows in gt

---

Functions in this module:

- `summary_rows()`
- `grand_summary_rows()`

---

``` r
summary_rows(
  data,
  groups = NULL,
  columns = TRUE,
  fns,
  missing_text = "---",
  formatter = fmt_number,
  ...
)
```

---

```{r}
exibble %>%
  gt(rowname_col = "row", groupname_col = "group") %>%
  summary_rows(
    groups = c("grp_a", "grp_b"), # <- `TRUE` also works to target all groups
    columns = vars(num),
    fns = list(sum = ~ sum(., na.rm = TRUE))
  )
```

---

### `grand_summary_rows()`: Add grand summary rows using aggregation functions

``` r
grand_summary_rows(
  data,
  columns = TRUE,
  fns,
  missing_text = "---",
  formatter = fmt_number,
  ...
)
```
```{r}
exibble %>%
  gt(rowname_col = "row", groupname_col = "group") %>%
  summary_rows(
    groups = c("grp_a", "grp_b"), # <- `TRUE` also works to target all groups
    columns = vars(num),
    fns = list(sum = ~ sum(., na.rm = TRUE))) %>%
  grand_summary_rows(
    columns = vars(num),
    fns = list(sum = ~ sum(., na.rm = TRUE))) 
  
```

---

class: middle

# Summary

.pull-left[
    
### summary_rows()
### grand_summary_rows()
]

.pull-right[
  
### summary rows/grp
### summary rows for tbl
  
]

---

class: middle

# tbl option functions in gt

---

```{r}
exibble %>%
  dplyr::select(num, currency) %>%
  gt(id = "one") %>%
  fmt_currency(
    columns = vars(currency),
    currency = "HKD"
  ) %>%
  fmt_scientific(
    columns = vars(num)
  ) %>%
  opt_css(
    css = "
  #one .gt_table {
    background-color: skyblue;
  }
  #one .gt_row {
    padding: 20px 30px;
  }
  #one .gt_col_heading {
    text-align: center !important;
  }
  "
  )
```

---

class: middle

# Summary

.pull-left[
    
### opt_row_striping()
### opt_table_lines()
### opt_table_outline
### opt_css()
]

.pull-right[
  
### row striping to data rows
### tbl lines
### tbl outline
### hack tbl css
  
]

---

class: middle

# Acknowledgments

### I would like to specially acknowledge the work of ***Richard Iannone*** (https://github.com/rich-iannone). He developed the packages and all the material for my presentation are from his vignettes and his NHS-R gt workshop

---
